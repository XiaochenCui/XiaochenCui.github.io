<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.57.2" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="" />
  <meta property="og:url" content="https://cuixiaochen.com/posts/mysql-%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE/" />
  <link rel="canonical" href="https://cuixiaochen.com/posts/mysql-%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE/" /><link rel="shortcut icon" href="/favicon.png" type="image/x-png" /><script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/cuixiaochen.com\/"
      },
      "articleSection" : "posts",
      "name" : "mysql 日志配置",
      "headline" : "mysql 日志配置",
      "description" : "\x3ch1 id=\x22概览\x22\x3e概览\x3c\/h1\x3e\n\n\x3cp\x3e本文主要讲解 mysql 的日志配置，以及介绍 mysql5.7 对于慢查询配置项的更新\x3c\/p\x3e\n\n\x3ch1 id=\x22日志分类\x22\x3e日志分类\x3c\/h1\x3e\n\n\x3cp\x3e我们将开启以下三种日志：\x3c\/p\x3e\n\n\x3cul\x3e\n\x3cli\x3e\x3cstrong\x3e错误日志\x3c\/strong\x3e：包含 mysql 启动时 \/ 运行时 \/ 停止时发生的错误\x3c\/li\x3e\n\x3cli\x3e\x3cstrong\x3e普通日志\x3c\/strong\x3e：包含 mysql 客户端连接 \/ 断开连接 \/ 执行查询操作的信息\x3c\/li\x3e\n\x3cli\x3e\x3cstrong\x3e慢查询日志\x3c\/strong\x3e：包含造成慢查询的 SQL 语句\x3c\/li\x3e\n\x3c\/ul\x3e\n\n\x3cp\x3e我们不会开启 \x3ca href=\x22https:\/\/dev.mysql.com\/doc\/refman\/5.7\/en\/binary-log.html\x22\x3eBinary Log\x3c\/a\x3e, 因为它对服务器的硬件有很高要求，很影响数据库的性能，而且只在某些特点情况下有用（如：建立复制集，建立主 - 从模式，执行一些特殊的数据恢复操作等）。\x3c\/p\x3e",
      "inLanguage" : "en-US",
      "author" : "",
      "creator" : "",
      "publisher": "",
      "accountablePerson" : "",
      "copyrightHolder" : "",
      "copyrightYear" : "2018",
      "datePublished": "2018-01-03 19:45:12 \x2b0000 UTC",
      "dateModified" : "2018-01-03 19:45:12 \x2b0000 UTC",
      "url" : "https:\/\/cuixiaochen.com\/posts\/mysql-%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE\/",
      "keywords" : [ "mysql", ]
  }
</script>
<title>mysql 日志配置 - XiaochenCui&#39;s Blog</title>
  <meta property="og:title" content="mysql 日志配置 - XiaochenCui&#39;s Blog" />
  <meta property="og:type" content="article" />
  <meta name="description" content="概览

本文主要讲解 mysql 的日志配置，以及介绍 mysql5.7 对于慢查询配置项的更新

日志分类

我们将开启以下三种日志：


错误日志：包含 mysql 启动时 / 运行时 / 停止时发生的错误
普通日志：包含 mysql 客户端连接 / 断开连接 / 执行查询操作的信息
慢查询日志：包含造成慢查询的 SQL 语句


我们不会开启 Binary Log, 因为它对服务器的硬件有很高要求，很影响数据库的性能，而且只在某些特点情况下有用（如：建立复制集，建立主 - 从模式，执行一些特殊的数据恢复操作等）。" />

  <link rel="stylesheet" href="https://unpkg.com/flexboxgrid@6.3.1/dist/flexboxgrid.min.css" />
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/tomorrow.min.css" />
  <link rel="stylesheet" href="/css/index.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml" title="XiaochenCui&#39;s Blog">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker" rel="stylesheet">
  
  <script>
    

    (function (undefined) { }).call('object' === typeof window && window || 'object' === typeof self && self || 'object' === typeof global && global || {});
  </script>

  
</head>

<body>
  <article class="post " id="article">
    <div class="row">
      <div class="col-xs-12 col-sm-10 col-md-8 col-sm-offset-1 col-md-offset-2 col-lg-6 col-lg-offset-3">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">Xiaochen Cui</a>
  </div>
</header>
<div class="row end-xs">
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">mysql 日志配置</h1>
          
        </header>

        <div class="post-content markdown-body">
          <h1 id="概览">概览</h1>

<p>本文主要讲解 mysql 的日志配置，以及介绍 mysql5.7 对于慢查询配置项的更新</p>

<h1 id="日志分类">日志分类</h1>

<p>我们将开启以下三种日志：</p>

<ul>
<li><strong>错误日志</strong>：包含 mysql 启动时 / 运行时 / 停止时发生的错误</li>
<li><strong>普通日志</strong>：包含 mysql 客户端连接 / 断开连接 / 执行查询操作的信息</li>
<li><strong>慢查询日志</strong>：包含造成慢查询的 SQL 语句</li>
</ul>

<p>我们不会开启 <a href="https://dev.mysql.com/doc/refman/5.7/en/binary-log.html">Binary Log</a>, 因为它对服务器的硬件有很高要求，很影响数据库的性能，而且只在某些特点情况下有用（如：建立复制集，建立主 - 从模式，执行一些特殊的数据恢复操作等）。</p>

<h1 id="实施">实施</h1>

<h2 id="通过更改配置文件启用日志">通过更改配置文件启用日志</h2>

<p>这种方式需要重启服务器使变更生效，日志参数一般在 [mysqld] 部分进行配置。</p>

<p>打开 mysql 配置文件 my.cnf （在不同的发行版下位置不同，一般在 /etc 或者 /etc/mysql)</p>

<h3 id="错误日志">错误日志</h3>

<p>打开 /etc/mysql/conf.d/mysqld_safe_syslog.cnf, 编辑为：</p>

<pre><code>[mysqld_safe]
syslog
</code></pre>

<p>这是我们推荐的设置，将会使错误日志进入 syslog。如果不想让错误日志进入 syslog，可以注释或删除掉这一行，然后在 my.cnf 文件中新增下列配置项：</p>

<pre><code>[mysqld_safe]
log_error=/var/log/mysql/mysql_error.log

[mysqld]
log_error=/var/log/mysql/mysql_error.log
</code></pre>

<h3 id="普通日志">普通日志</h3>

<p>在 [mysqld] 在添加下面几行（或者把注释取消掉）：</p>

<pre><code>general_log_file        = /var/log/mysql/mysql.log
general_log             = 1
</code></pre>

<h3 id="慢查询日志">慢查询日志</h3>

<p>在 [mysqld] 下添加以下配置（或者把注释取消掉）：</p>

<pre><code>slow_query_log = 1
slow_query_log_file = /var/log/mysql/mysql-slow.log
long_query_time = 2
log-queries-not-using-indexes
</code></pre>

<h3 id="重启服务器">重启服务器</h3>

<p>在更新配置后需要重启服务器：</p>

<ul>
<li>upstart:
<code>$ service mysql restart</code></li>
<li>systemd:
<code>$ systemctl restart mysql.service</code></li>
</ul>

<h2 id="在运行中启用日志">在运行中启用日志</h2>

<p>从 mysql5.1 开始，日志可以在运行中启用</p>

<p>登录 mysql clinet, 在 在运行中启用日志：</p>

<pre><code>SET GLOBAL general_log = 'ON';
SET GLOBAL slow_query_log = 'ON';
</code></pre>

<p>在运行中禁用日志：</p>

<pre><code>SET GLOBAL general_log = 'OFF';
SET GLOBAL slow_query_log = 'OFF';
</code></pre>

<h2 id="日志轮转">日志轮转</h2>

<p>为了防止日志文件过大，我们还需要启用日志轮转</p>

<h3 id="ubuntu">Ubuntu</h3>

<p>打开 <code>/etc/logrotate.d/mysql-server</code>, 加入以下配置：</p>

<pre><code># - I put everything in one block and added sharedscripts, so that mysql gets
#   flush-logs'd only once.
#   Else the binary logs would automatically increase by n times every day.
# - The error log is obsolete, messages go to syslog now.
/var/log/mysql.log /var/log/mysql/*log {
        daily
        rotate 7
        missingok
        create 640 mysql adm
        compress
        sharedscripts
        postrotate
                test -x /usr/bin/mysqladmin || exit 0
                # If this fails, check debian.conf!
                MYADMIN=&quot;/usr/bin/mysqladmin --defaults-file=/etc/mysql/debian.cnf&quot;
                if [ -z &quot;`$MYADMIN ping 2&gt;/dev/null`&quot; ]; then
                  # Really no mysqld or rather a missing debian-sys-maint user?
                  # If this occurs and is not a error please report a bug.
                  #if ps cax | grep -q mysqld; then
                  if killall -q -s0 -umysql mysqld; then
                    exit 1
                  fi
                else
                  $MYADMIN flush-logs
                fi
        endscript
}
</code></pre>

<h3 id="centos">CentOS</h3>

<p>打开 <code>/etc/logrotate.d/mysql</code>, 加入以下配置：</p>

<pre><code># The log file name and location can be set in
# /etc/my.cnf by setting the &quot;log-error&quot; option
# in [mysqld]  section as follows:
#
# [mysqld]
# log-error=/var/log/mysqld.log
#
# For the mysqladmin commands below to work, root account
# password is required. Use mysql_config_editor(1) to store
# authentication credentials in the encrypted login path file
# ~/.mylogin.cnf
#
# Example usage:
#
#  mysql_config_editor set --login-path=client --user=root --host=localhost --password
#
# When these actions has been done, un-comment the following to
# enable rotation of mysqld's log error.
#

/var/log/mysqld.log {
        create 640 mysql mysql
        notifempty
        daily
        rotate 5
        missingok
        compress
    postrotate
       # just if mysqld is really running
       if test -x /usr/bin/mysqladmin &amp;&amp; \
          /usr/bin/mysqladmin ping &amp;&gt;/dev/null
       then
          /usr/bin/mysqladmin flush-logs
       fi
    endscript
}
</code></pre>

<h2 id="检查日志配置">检查日志配置</h2>

<p>用 <code>show variables like '%log%';</code> 检查日志配置项：</p>

<pre><code>mysql&gt; show variables like '%log%';
+-----------------------------------------+-------------------------------------------+
| Variable_name                           | Value                                     |
+-----------------------------------------+-------------------------------------------+
| back_log                                | 80                                        |
| binlog_cache_size                       | 32768                                     |
| binlog_checksum                         | CRC32                                     |
| binlog_direct_non_transactional_updates | OFF                                       |
| binlog_error_action                     | ABORT_SERVER                              |
| binlog_format                           | ROW                                       |
| binlog_group_commit_sync_delay          | 0                                         |
| binlog_group_commit_sync_no_delay_count | 0                                         |
| binlog_gtid_simple_recovery             | ON                                        |
| binlog_max_flush_queue_time             | 0                                         |
| binlog_order_commits                    | ON                                        |
| binlog_row_image                        | FULL                                      |
| binlog_rows_query_log_events            | OFF                                       |
| binlog_stmt_cache_size                  | 32768                                     |
| expire_logs_days                        | 10                                        |
| general_log                             | ON                                        |
| general_log_file                        | /var/log/mysql/mysql.log                  |
| innodb_api_enable_binlog                | OFF                                       |
| innodb_flush_log_at_timeout             | 1                                         |
| innodb_flush_log_at_trx_commit          | 1                                         |
| innodb_locks_unsafe_for_binlog          | OFF                                       |
| innodb_log_buffer_size                  | 16777216                                  |
| innodb_log_checksums                    | ON                                        |
| innodb_log_compressed_pages             | ON                                        |
| innodb_log_file_size                    | 50331648                                  |
| innodb_log_files_in_group               | 2                                         |
| innodb_log_group_home_dir               | ./                                        |
| innodb_log_write_ahead_size             | 8192                                      |
| innodb_max_undo_log_size                | 1073741824                                |
| innodb_online_alter_log_max_size        | 134217728                                 |
| innodb_undo_log_truncate                | OFF                                       |
| innodb_undo_logs                        | 128                                       |
| log_bin                                 | OFF                                       |
| log_bin_basename                        |                                           |
| log_bin_index                           |                                           |
| log_bin_trust_function_creators         | OFF                                       |
| log_bin_use_v1_row_events               | OFF                                       |
| log_builtin_as_identified_by_password   | OFF                                       |
| log_error                               | /var/log/mysql/error.log                  |
| log_error_verbosity                     | 3                                         |
| log_output                              | FILE                                      |
| log_queries_not_using_indexes           | ON                                        |
| log_slave_updates                       | OFF                                       |
| log_slow_admin_statements               | OFF                                       |
| log_slow_slave_statements               | OFF                                       |
| log_statements_unsafe_for_binlog        | ON                                        |
| log_syslog                              | OFF                                       |
| log_syslog_facility                     | daemon                                    |
| log_syslog_include_pid                  | ON                                        |
| log_syslog_tag                          |                                           |
| log_throttle_queries_not_using_indexes  | 0                                         |
| log_timestamps                          | UTC                                       |
| log_warnings                            | 2                                         |
| max_binlog_cache_size                   | 18446744073709547520                      |
| max_binlog_size                         | 104857600                                 |
| max_binlog_stmt_cache_size              | 18446744073709547520                      |
| max_relay_log_size                      | 0                                         |
| relay_log                               |                                           |
| relay_log_basename                      | /var/lib/mysql/zcheng2115-relay-bin       |
| relay_log_index                         | /var/lib/mysql/zcheng2115-relay-bin.index |
| relay_log_info_file                     | relay-log.info                            |
| relay_log_info_repository               | FILE                                      |
| relay_log_purge                         | ON                                        |
| relay_log_recovery                      | OFF                                       |
| relay_log_space_limit                   | 0                                         |
| slow_query_log                          | ON                                        |
| slow_query_log_file                     | /var/log/mysql/mysql-slow.log             |
| sql_log_bin                             | ON                                        |
| sql_log_off                             | OFF                                       |
| sync_binlog                             | 1                                         |
| sync_relay_log                          | 10000                                     |
| sync_relay_log_info                     | 10000                                     |
+-----------------------------------------+-------------------------------------------+
72 rows in set (0.00 sec)
</code></pre>

<h2 id="慢查询变量的更新">慢查询变量的更新</h2>

<p>某些文章中介绍的启用慢查询日志的配置项为 <code>log-slow-queries</code>, <a href="https://dev.mysql.com/doc/refman/5.5/en/slow-query-log.html">在 mysql 5.5 中，这个配置项已经被弃用</a></p>

<h1 id="参考">参考</h1>

<ul>
<li><a href="http://www.pontikis.net/blog/how-and-when-to-enable-mysql-logs">How and When To Enable MySQL Logs</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/server-logs.html">MySQL :: MySQL 5.7 Reference Manual :: 5.4 MySQL Server Logs</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/slow-query-log.html">MySQL :: MySQL 5.7 Reference Manual :: 5.4.5 The Slow Query Log</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/binary-log.html">MySQL :: MySQL 5.7 Reference Manual :: 5.4.4 The Binary Log</a></li>
<li><a href="https://stackoverflow.com/questions/36893799/mysql-5-7-log-slow-queries-error">my.cnf - mysql 5.7 log-slow-queries error - Stack Overflow</a></li>
</ul>
        </div>

        

        


        
        
        <div style="height: 50px;"></div>
        
        <div class="post-comments">
          <div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://cuixiaochen.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>

        </div>
        
        

        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="https://github.com/XiaochenCui" target="_blank">Github</a>
  </div>
  
  <div class="site-footer-item">
    <a href="mailto://jcnlcxc.new@gmail.com" target="_blank">Email</a>
  </div>
  
  
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>
<script src="https://unpkg.com/quicklink@0.1.1/dist/quicklink.umd.js"></script>

<script>
  hljs.initHighlightingOnLoad();
  
  var posts = document.getElementById('posts-list');
  posts && quicklink({
    el: posts,
    priority: true,
  });
</script>

  

</body>

</html>