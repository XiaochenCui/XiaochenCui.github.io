<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.5" rel="stylesheet" type="text/css" />




  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png?v=6.0.5">










<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.0.5',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="python,django,orm," />


<meta name="description" content="本文翻译自 Medium 上的 9 Django Tips for Working with Databases, 原作者 Haki Benita。">
<meta name="keywords" content="python,django,orm">
<meta property="og:type" content="article">
<meta property="og:title" content="Django 操作数据库时的 9 条小提示（译）">
<meta property="og:url" content="https://cuixiaochen.com/2018/02/01/9-Django-Tips-for-Working-with-Databases-Translate/index.html">
<meta property="og:site_name" content="XiaochenCui&#39;s Blog">
<meta property="og:description" content="本文翻译自 Medium 上的 9 Django Tips for Working with Databases, 原作者 Haki Benita。">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-10-17T03:03:00.406Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Django 操作数据库时的 9 条小提示（译）">
<meta name="twitter:description" content="本文翻译自 Medium 上的 9 Django Tips for Working with Databases, 原作者 Haki Benita。">



  <link rel="alternate" href="/atom.xml" title="XiaochenCui's Blog" type="application/atom+xml" />




  <link rel="canonical" href="https://cuixiaochen.com/2018/02/01/9-Django-Tips-for-Working-with-Databases-Translate/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>Django 操作数据库时的 9 条小提示（译） | XiaochenCui's Blog</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-82276339-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-82276339-1');
</script>






  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">XiaochenCui's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">相隔天堑 却不觉遥远</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://cuixiaochen.com/2018/02/01/9-Django-Tips-for-Working-with-Databases-Translate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiaochen Cui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/lego1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XiaochenCui's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Django 操作数据库时的 9 条小提示（译）</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-01T16:06:39+08:00">2018-02-01</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-10-17T11:03:00+08:00">2018-10-17</time>
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/01/9-Django-Tips-for-Working-with-Databases-Translate/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/02/01/9-Django-Tips-for-Working-with-Databases-Translate/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文翻译自 <a href="https://medium.com/" target="_blank" rel="noopener">Medium</a> 上的 <a href="https://medium.com/@hakibenita/9-django-tips-for-working-with-databases-beba787ed7d3" target="_blank" rel="noopener">9 Django Tips for Working with Databases</a>, 原作者 <a href="https://medium.com/@hakibenita" target="_blank" rel="noopener">Haki Benita</a>。</p>
<a id="more"></a>
<h1 id="用-filter-做聚合-aggregation-操作"><a href="#用-filter-做聚合-aggregation-操作" class="headerlink" title="用 filter 做聚合 (aggregation) 操作"></a>用 filter 做聚合 (aggregation) 操作</h1><p>在 Django 2.0 之前，如果我们想获取诸如用户总数或者已激活的用户总数等信息，通常需要诉诸于使用 <a href="https://docs.djangoproject.com/en/2.0/ref/models/conditional-expressions/" target="_blank" rel="noopener">condition 表达式</a>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> (</span><br><span class="line">    Count,</span><br><span class="line">    Sum,</span><br><span class="line">    Case,</span><br><span class="line">    When,</span><br><span class="line">    Value,</span><br><span class="line">    IntegerField,</span><br><span class="line">)</span><br><span class="line">User.objects.aggregate(</span><br><span class="line">    total_users=Count(<span class="string">'id'</span>),</span><br><span class="line">    total_active_users=Sum(Case(</span><br><span class="line">        When(is_active=<span class="keyword">True</span>, then=Value(<span class="number">1</span>)),</span><br><span class="line">        default=Value(<span class="number">0</span>),</span><br><span class="line">        output_field=IntegerField(),</span><br><span class="line">    )),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>在 Django 2.0 中加入的在聚合函数中使用 filter 参数简化了这一操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Count, F</span><br><span class="line">User.objects.aggregate(</span><br><span class="line">    total_users=Count(<span class="string">'id'</span>),</span><br><span class="line">    total_active_users=Count(<span class="string">'id'</span>, filter=F(<span class="string">'is_active'</span>)),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>假设我们正在使用 PostgerSQL, 上面两条查询对应的 SQL 语句是：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">COUNT</span>(<span class="keyword">id</span>) <span class="keyword">AS</span> total_users,</span><br><span class="line">    <span class="keyword">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> is_active <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) <span class="keyword">AS</span> total_active_users</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    auth_users;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">COUNT</span>(<span class="keyword">id</span>) <span class="keyword">AS</span> total_users,</span><br><span class="line">    <span class="keyword">COUNT</span>(<span class="keyword">id</span>) FILTER (<span class="keyword">WHERE</span> is_active) <span class="keyword">AS</span> total_active_users</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    auth_users;</span><br></pre></td></tr></table></figure>
<p>第二条查询使用了 FILTER(WHERE…) 语句。</p>
<h1 id="QuerySet-的结果作为-namedtuples-返回"><a href="#QuerySet-的结果作为-namedtuples-返回" class="headerlink" title="QuerySet 的结果作为 namedtuples 返回"></a>QuerySet 的结果作为 namedtuples 返回</h1><p>在 Django 2.0 中 <a href="https://docs.djangoproject.com/en/2.0/ref/models/querysets/#django.db.models.query.QuerySet.values_list" target="_blank" rel="noopener">values_list 可以接收一个叫做 named 的参数</a>。当 named 为 True 的时候，values_list 将会返回一个由 namedtuple 组成的列表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; user.objects.values_list(</span><br><span class="line">    <span class="string">'first_name'</span>,</span><br><span class="line">    <span class="string">'last_name'</span>,</span><br><span class="line">)[<span class="number">0</span>]</span><br><span class="line">(‘Haki’, ‘Benita’)</span><br><span class="line">&gt; user_names = User.objects.values_list(</span><br><span class="line">    <span class="string">'first_name'</span>,</span><br><span class="line">    <span class="string">'last_name'</span>,</span><br><span class="line">    named=<span class="keyword">True</span>,</span><br><span class="line">)</span><br><span class="line">&gt; user_names[<span class="number">0</span>]</span><br><span class="line">Row(first_name=<span class="string">'Haki'</span>, last_name=<span class="string">'Benita'</span>)</span><br><span class="line">&gt; user_names[<span class="number">0</span>].first_name</span><br><span class="line"><span class="string">'Haki'</span></span><br><span class="line">&gt; user_names[<span class="number">0</span>].last_name</span><br><span class="line"><span class="string">'Benita'</span></span><br></pre></td></tr></table></figure>
<h1 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h1><p>Django ORM 非常实用而且功能丰富，但是它不可能满足所有的数据库。幸运的是 ORM 允许我们用自定义函数来对它进行扩展。</p>
<p>假设我们有一个 Report model，其中包含一个 duration 字段。如果要获取平均延期时间的话：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Avg</span><br><span class="line">Report.objects.aggregate(avg_duration=Avg(‘duration’))</span><br><span class="line">&gt; &#123;<span class="string">'avg_duration'</span>: datetime.timedelta(<span class="number">0</span>, <span class="number">0</span>, <span class="number">55432</span>)&#125;</span><br></pre></td></tr></table></figure>
<p>但是当我们想要获取标准差的时候：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Avg, StdDev</span><br><span class="line">Report.objects.aggregate(</span><br><span class="line">    avg_duration=Avg(<span class="string">'duration'</span>),</span><br><span class="line">    std_duration=StdDev(<span class="string">'duration'</span>),</span><br><span class="line">)</span><br><span class="line">ProgrammingError: function stddev_pop(interval) does <span class="keyword">not</span> exist</span><br><span class="line">LINE <span class="number">1</span>: SELECT STDDEV_POP(<span class="string">"report"</span>.<span class="string">"duration"</span>) AS <span class="string">"std_dura...</span></span><br><span class="line"><span class="string">               ^</span></span><br><span class="line"><span class="string">HINT:  No function matches the given name and argument types. You might need to add explicit type casts.</span></span><br></pre></td></tr></table></figure>
<p>这就出现了问题，因为 PostgreSQL 不支持对于 interval type 的 stddev 操作。我们得先把 interval 转换成 number, 然后再对其进行 <code>STDDEV_POP</code> 操作。</p>
<p>解决方法之一就是在 duration 上执行 epoch 操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    AVG(duration),</span><br><span class="line">    STDDEV_POP(EXTRACT(EPOCH FROM duration))</span><br><span class="line">FROM</span><br><span class="line">    report;</span><br><span class="line">      avg       |    stddev_pop</span><br><span class="line">----------------+------------------</span><br><span class="line"> 00:00:00.55432 | 1.06310113695549</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>
<p>通过<a href="https://docs.djangoproject.com/en/2.0/ref/models/expressions/#func-expressions" target="_blank" rel="noopener">自定义函数</a>，我们可以在 Django 中进行这个操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># common/db.py</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Func</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Epoch</span><span class="params">(Func)</span>:</span></span><br><span class="line">   function = <span class="string">'EXTRACT'</span></span><br><span class="line">   template = <span class="string">"%(function)s('epoch' from %(expressions)s)"</span></span><br></pre></td></tr></table></figure>
<p>然后使用这个新的函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from django.db.models import Avg, StdDev, F</span><br><span class="line">from common.db import Epoch</span><br><span class="line">Report.objects.aggregate(</span><br><span class="line">    avg_duration=Avg(&apos;duration&apos;),</span><br><span class="line">    std_duration=StdDev(Epoch(F(&apos;duration&apos;))),</span><br><span class="line">)</span><br><span class="line">&#123;&apos;avg_duration&apos;: datetime.timedelta(0, 0, 55432),</span><br><span class="line"> &apos;std_duration&apos;: 1.06310113695549&#125;</span><br></pre></td></tr></table></figure>
<p>注意我们在 Epoch 中使用了 <a href="https://docs.djangoproject.com/en/2.0/ref/models/expressions/#f-expressions" target="_blank" rel="noopener">F 表达式</a></p>
<p>『译者注』可能某些读者没接触过 PostgreSQL, 我在这里贴出一些链接，帮助大家了解一下本段中涉及到的 PostgreSQL 关键字：</p>
<ul>
<li><a href="http://www.postgresqltutorial.com/postgresql-interval/" target="_blank" rel="noopener">interval data type</a></li>
<li><a href="https://w3resource.com/PostgreSQL/extract-function.php" target="_blank" rel="noopener">EXTRACT</a></li>
<li><a href="https://www.cloudera.com/documentation/enterprise/5-3-x/topics/impala_stddev.html" target="_blank" rel="noopener">STDDEV_POP</a></li>
</ul>
<h1 id="语句超时"><a href="#语句超时" class="headerlink" title="语句超时"></a>语句超时</h1><p>这可能是本文给出的最重要、最简洁的建议。在编写应用时出错是难以避免的事情，我们无法预料并处理所有的边界情况 (edge case)，所以<strong>我们必须设置边界</strong>。</p>
<p>不同于那些非阻塞的 app 服务器（如 Tornado, asyncio 或 Node），Django 使用阻塞式的工作进程。这意味着<strong>如果一个用户执行了一项长耗时操作，则在这项操作完成前，工作进程会一直阻塞且无法被其他用户使用</strong>。</p>
<p>虽然没人会在生产环境中使用单个工作进程，我们仍然应该确保单个查询不会占用过多的时间。</p>
<p>在大多数 Django 应用中数据库查询都会占用很多时间，所以<strong><a href="https://www.postgresql.org/docs/9.6/static/runtime-config-client.html#GUC-STATEMENT-TIMEOUT" target="_blank" rel="noopener">为 SQL 查询设置超时</a> 是一个很好的习惯</strong>。</p>
<p>我们通常会在 wsgi.py 中做全局超时设置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wsgi.py</span></span><br><span class="line"><span class="keyword">from</span> django.db.backends.signals <span class="keyword">import</span> connection_created</span><br><span class="line"><span class="keyword">from</span> django.dispatch <span class="keyword">import</span> receiver</span><br><span class="line"><span class="meta">@receiver(connection_created)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup_postgres</span><span class="params">(connection, **kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> connection.vendor != <span class="string">'postgresql'</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Timeout statements after 30 seconds.</span></span><br><span class="line">    <span class="keyword">with</span> connection.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">        cursor.execute(<span class="string">"""</span></span><br><span class="line"><span class="string">            SET statement_timeout TO 30000;</span></span><br><span class="line"><span class="string">        """</span>)</span><br></pre></td></tr></table></figure>
<p>这样做使得超时设置只会影响工作进程，而不会影响统计查询与 cronjob。</p>
<p>同时，我们应该使用<a href="https://docs.djangoproject.com/en/2.0/ref/databases/#persistent-connections" target="_blank" rel="noopener">持久化数据库连接</a>，使得我们不需要为每一个请求付出建立数据库连接的代价。</p>
<p>边注：另一项非常耗时的操作是网络通讯，所以我们也应该在调用远程服务时设置超时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">response = requests.get(</span><br><span class="line">    &apos;https://api.slow-as-hell.com&apos;,</span><br><span class="line">    timeout=3000,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h1 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h1><p>这一条建议同样与设置边界有关。有时候我们会希望用户输入一些数据，然后我们呈现出一份图表给他们。这一类的视图通常会在生产环境中产生一些奇怪的行为。</p>
<p>用户希望导出所有订单的情况并不罕见，当前标签页“卡住”时打开另一个标签页进行尝试也是很常见的情形。</p>
<p>这就是我们为什么要对查询做限制。</p>
<p>我们来试着做一个查询，返回不超过 100 行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一个错误的示范</span></span><br><span class="line">data = list(Sale.objects.all())[:<span class="number">100</span>]</span><br></pre></td></tr></table></figure>
<p>这是一个错误的示范，程序将会把海量订单载入内存，然后截取前 100 项。</p>
<p>我们尝试改进一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data = Sale.objects.all()[:<span class="number">100</span>]</span><br></pre></td></tr></table></figure>
<p>这个语句比之前的要好一些，Django 将会在查询中使用 limit 来获取前 100 行。</p>
<p>在这里遇到了另一个问题：当用户查询所有订单时，程序仍然会只返回 100 行数据。</p>
<p>我们继续改进之前的程序，当订单总数大于 100 时，抛出一个异常：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LIMIT = <span class="number">100</span></span><br><span class="line"><span class="keyword">if</span> Sales.objects.count() &gt; LIMIT:</span><br><span class="line">    <span class="keyword">raise</span> ExceededLimit(LIMIT)</span><br><span class="line"><span class="keyword">return</span> Sale.objects.all()[:LIMIT]</span><br></pre></td></tr></table></figure>
<p>这个片段能正常工作，但现在程序将会进行两次查询。</p>
<p>我们继续改进：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LIMIT = <span class="number">100</span></span><br><span class="line">data = Sale.objects.all()[:(LIMIT + <span class="number">1</span>)]</span><br><span class="line"><span class="keyword">if</span> len(data) &gt; LIMIT:</span><br><span class="line">    <span class="keyword">raise</span> ExceededLimit(LIMIT)</span><br><span class="line"><span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>
<p>我们现在获取前 101 行而不是 100 行，如果第 101 行数据存在，则我们知道数据总数大于 100。</p>
<p>LIMIT + 1 这个技巧很多时候非常使用。</p>
<h1 id="Select-for-update-…-of"><a href="#Select-for-update-…-of" class="headerlink" title="Select for update … of"></a>Select for update … of</h1><p>我们将会用一个 bug 来开始这一小节。这个 bug 发生在半夜，根源是数据库锁，最后造成了查询超时。</p>
<p>一个常用的<a href="https://medium.com/p/bullet-proofing-django-models-c080739be4e" target="_blank" rel="noopener">进行交易的模式</a> 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> transaction <span class="keyword">as</span> db_transaction</span><br><span class="line">...</span><br><span class="line"><span class="keyword">with</span> db_transaction.atomic():</span><br><span class="line">  transaction = (</span><br><span class="line">        Transaction.objects</span><br><span class="line">        .select_related(</span><br><span class="line">            <span class="string">'user'</span>,</span><br><span class="line">            <span class="string">'product'</span>,</span><br><span class="line">            <span class="string">'product__category'</span>,</span><br><span class="line">        )</span><br><span class="line">        .select_for_update()</span><br><span class="line">        .get(uid=uid)</span><br><span class="line">  )</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>涉及到交易的操作通常包含 user 和 product，所以我们通常使用 <a href="https://docs.djangoproject.com/en/2.0/ref/models/querysets/#select-related" target="_blank" rel="noopener">select_related</a> 来进行强制关联，减少查询次数。</p>
<p>到目前为止，问题还没有显现出来。</p>
<p>我们有一些 <a href="https://en.wikipedia.org/wiki/Extract,_transform,_load" target="_blank" rel="noopener">ETL</a> 程序在半夜进行，维护 user 表和 product 表。这些 ETL 程序会执行更新和插入操作，所以他们也会请求获取锁。</p>
<p>所以问题的根源在于：当 <a href="https://docs.djangoproject.com/en/2.0/ref/models/querysets/#select-for-update" target="_blank" rel="noopener">select_for_update</a> 和 select_related 一起使用的时候，Django 将会对本次查询涉及到对所有表加锁。</p>
<p>我们的程序尝试同时在 transaction, user, product 和 category 表上加锁，当 ETL 程序在半夜将后三个表加锁后，交易便失败了。</p>
<p>为了解决这个问题，<a href="https://docs.djangoproject.com/en/2.0/releases/2.0/#database-backend-api" target="_blank" rel="noopener">Django 2.0 中为 select_for_update 引入了一个新的参数</a>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> transaction <span class="keyword">as</span> db_transaction</span><br><span class="line">...</span><br><span class="line"><span class="keyword">with</span> db_transaction.atomic():</span><br><span class="line">  transaction = (</span><br><span class="line">        Transaction.objects</span><br><span class="line">        .select_related(</span><br><span class="line">            <span class="string">'user'</span>,</span><br><span class="line">            <span class="string">'product'</span>,</span><br><span class="line">            <span class="string">'product__category'</span>,</span><br><span class="line">        )</span><br><span class="line">        .select_for_update(</span><br><span class="line">            of=(<span class="string">'self'</span>,)</span><br><span class="line">        )</span><br><span class="line">        .get(uid=uid)</span><br><span class="line">  )</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>select_for_update 现在加入了 <code>of</code> 参数，使用 <code>of</code> 可以让我们明确指定对哪个表加锁。<code>self</code> 是一个特殊的关键字，表示我们想对当前 model 对应的表加锁（在我们的例子中，是 transaction）。</p>
<p>到目前为止，这个功能只可用于 PostgreSQL 和 Oracle。</p>
<h1 id="外键索引"><a href="#外键索引" class="headerlink" title="外键索引"></a>外键索引</h1><p>当创建一个 model 时，Django 将会在外键上自动创建一个 B-Tree 索引，B-Tree 索引会增加程序的负担，而且有时候索引并不是必要的。</p>
<p>一个经典的例子就是下面这用来存储成员关系的关系 model:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Membership(Model):</span><br><span class="line">    group = ForeignKey(Group)</span><br><span class="line">    user = ForeignKey(User)</span><br></pre></td></tr></table></figure>
<p>Django 将会隐式地为上面这个 model 创建两个索引，一个在 group 字段上，另一个在 user 字段上。</p>
<p>在关系 model 中，一个常用的模式是为两个字段添加唯一性约束。在我们的例子中表现为一个用户只能在同一个组中出现一次：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Membership(Model):</span><br><span class="line">    group = ForeignKey(Group)</span><br><span class="line">    user = ForeignKey(User)</span><br><span class="line">    class Meta:</span><br><span class="line">        unique_together = (</span><br><span class="line">           &apos;group&apos;,</span><br><span class="line">           &apos;user&apos;,</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>unique_together 也会创建一个索引，作用于这两个字段。所以我们这个 model 最终拥有 3 个 fiele 和 2 个索引。在很多情况下（取决于业务需求），我们可以解除掉外键索引，只保留唯一性约束创建的索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Membership(Model):</span><br><span class="line">    group = ForeignKey(Group)</span><br><span class="line">    user = ForeignKey(User)</span><br><span class="line">    class Meta:</span><br><span class="line">        unique_together = (</span><br><span class="line">           &apos;group&apos;,</span><br><span class="line">           &apos;user&apos;,</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>移除多余的索引可以加快插入和更新操作的速度，同时减轻了数据库的负载。</p>
<h1 id="复合索引中列的顺序"><a href="#复合索引中列的顺序" class="headerlink" title="复合索引中列的顺序"></a>复合索引中列的顺序</h1><p>在多个列上构建的索引被称为<strong>复合索引</strong>。在 B-Tree 复合索引中，第一列用树结构构建索引，第二列在第一层叶子节点的基础上构建树结构，然后依此类推。</p>
<p><strong>所以索引中列的顺序意义重大。</strong></p>
<p>在这个例子中，我们首先会构建一个树存储所有的组，然后对于每一个组构建一个树，存储它的所有组员。</p>
<p>对于 B-Tree 树来说，我们的经验法则是让第二层索引尽可能的小。换句话来说，基数更高的列（即不同的值更多）应该被放在前面。</p>
<p>在这个例子中，我们可以作出一个合理的假设，即认为用户比组多。所以将用户列放在前面可以使第二级索引为组而构建，使索引更小。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Membership(Model):</span><br><span class="line">    group = ForeignKey(Group, db_index=False)</span><br><span class="line">    user = ForeignKey(User, db_index=False)</span><br><span class="line">    class Meta:</span><br><span class="line">        unique_together = (</span><br><span class="line">            &apos;user&apos;,</span><br><span class="line">            &apos;group&apos;,</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>这只是一个经验之谈，所以你应该对此持保留态度。最终的索引需要根据具体的使用情景来进行优化。这一小节的重点是告诉你要<strong>注意隐式索引，注意复合索引中列顺序的重大意义。</strong></p>
<h1 id="BRIN-索引"><a href="#BRIN-索引" class="headerlink" title="BRIN 索引"></a>BRIN 索引</h1><p>B-Tree 的结构就像一棵树一样。当随机访问数据表时，查询一个值的代价是使树的高度加 1。所以对于一致性约束和（某些）范围查询来说，B-Tree 索引是比较完美的。</p>
<p><strong>B-Tree 的缺点在于它的大小，它有时候会变得非常大。</strong></p>
<p><a href="https://medium.com/@Alibaba_Cloud/principles-and-applications-of-the-index-types-supported-by-postgresql-481f59bab67d" target="_blank" rel="noopener">PostgreSQL 提供了其它多种索引，供我们用于不同的场景。</a></p>
<p>Django 1.11 加入了一个新的 Meta 选项来控制索引，使得我们有机会去探索其它类型的索引。</p>
<p>PostgreSQL 提供了一种特别使用的索引：BRIN(Block Range Index)。在某些场景下 BRIN 索引会比 B-Tree 索引更加高效。</p>
<p>来看一下<a href="https://www.postgresql.org/docs/9.5/static/brin-intro.html" target="_blank" rel="noopener">官方文档</a> 中的说明：</p>
<blockquote>
<p>BRIN 主要针对于相对于其在表中的位置有自然关联性的列。</p>
</blockquote>
<p>接下来我们简单介绍一下 BRIN 的内部机制。BRIN 将会基于表中的相邻数据块创建一个小型索引。这个索引占用的空间很小，它只能告诉你给定值<strong>肯定不在某个区域</strong>或者<strong>可能在某个区域中</strong>（区域被索引的情况下）。</p>
<p>我们用一个简单的实例来演示一下 BRIN。</p>
<p>假设一列中有如下值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1, 2, 3, 4, 5, 6, 7, 8, 9</span><br></pre></td></tr></table></figure>
<p>然后把相邻的 3 个放在一个区域内：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1–3], [4–6], [7–9]</span><br></pre></td></tr></table></figure>
<p>我们利用这个索引来搜索 5:</p>
<ul>
<li><code>[1-3]</code> 肯定不在这个区域</li>
<li><code>[4-6]</code> 可能在这个区域</li>
<li><code>[7-9]</code> 肯定不在这个区域</li>
</ul>
<p>利用这个索引我们把搜索范围缩小到了区域 4-6。</p>
<p>我们再看一下另一个例子，在这个例子中列中的值是乱序的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2,9,5], [1,4,7], [3,8,6]</span><br></pre></td></tr></table></figure>
<p>然后用每个区域中的最大值和最小值生成索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2–9], [1–7], [3–8]</span><br></pre></td></tr></table></figure>
<p>接下来尝试去查找 5:</p>
<ul>
<li><code>[2-9]</code> 可能在这个区域中</li>
<li><code>[1-7]</code> 可能在这个区域中</li>
<li><code>[3-8]</code> 可能在这个区域中</li>
</ul>
<p>这个索引不仅没有缩小搜索的范围，同时还导致我们需要将索引和整个表的值一起读入。所以它起不到任何有效作用。</p>
<p>让我们再回到文档：</p>
<blockquote>
<p>… 与其在表中的物理位置有自然关联的列</p>
</blockquote>
<p>这是使用 BRIN 索引的关键。想要发挥出 BRIN 索引的作用，列中的值从整体来看应该有序或有聚集性地排列在硬盘上。</p>
<p>回到 Django 中，<a href="https://docs.djangoproject.com/en/2.0/ref/models/fields/#datefield" target="_blank" rel="noopener">auto_now_add</a> 列就是一个非常契合这个条件的场景，我们经常需要对 auto_now_add 列建立索引，同时它也基本上是自然有序地被存放在硬盘上。</p>
<p>如下面这个 model:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class SomeModel(Model):</span><br><span class="line">    created = DatetimeField(</span><br><span class="line">        auto_now_add=True,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p>当一行数据被创建时，Django 将会自动在 created 列插入当前时间。由于 created 列也经常被用在查询条件中，所以我们经常需要在上面建立索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from django.contrib.postgres.indexes import BrinIndex</span><br><span class="line">class SomeModel(Model):</span><br><span class="line">    created = DatetimeField(</span><br><span class="line">        auto_now_add=True,</span><br><span class="line">    )</span><br><span class="line">    class Meta:</span><br><span class="line">        indexes = (</span><br><span class="line">            BrinIndex(fields=[&apos;created&apos;]),</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>为了给大家一个直观的感受，我在表中创建列 200 万行数据，然后建立不同的索引：</p>
<ul>
<li>B-Tree 索引：37 MB</li>
<li>BRIN 索引：49 KB</li>
</ul>
<p>两者所占空间相差了 700 多倍。</p>
<p>虽然说在创建索引时，硬盘空间消耗并不是我们考虑的唯一因素。但是一般而言，我们可以在 Django 1.11 中使用新的索引支持，使查询更轻量，更快。</p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python/" rel="tag"># python</a>
          
            <a href="/tags/django/" rel="tag"># django</a>
          
            <a href="/tags/orm/" rel="tag"># orm</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/27/Cryptography-Week1-课后习题/" rel="next" title="Cryptography Week 1 - Problem Set">
                <i class="fa fa-chevron-left"></i> Cryptography Week 1 - Problem Set
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/11/42065/" rel="prev" title="遥控履带车：42065">
                遥控履带车：42065 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/lego1.jpg"
                alt="Xiaochen Cui" />
            
              <p class="site-author-name" itemprop="name">Xiaochen Cui</p>
              <p class="site-description motion-element" itemprop="description">崔晓晨写作的地方</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">36</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">20</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#用-filter-做聚合-aggregation-操作"><span class="nav-number">1.</span> <span class="nav-text">用 filter 做聚合 (aggregation) 操作</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#QuerySet-的结果作为-namedtuples-返回"><span class="nav-number">2.</span> <span class="nav-text">QuerySet 的结果作为 namedtuples 返回</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#自定义函数"><span class="nav-number">3.</span> <span class="nav-text">自定义函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#语句超时"><span class="nav-number">4.</span> <span class="nav-text">语句超时</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#限制"><span class="nav-number">5.</span> <span class="nav-text">限制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Select-for-update-…-of"><span class="nav-number">6.</span> <span class="nav-text">Select for update … of</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#外键索引"><span class="nav-number">7.</span> <span class="nav-text">外键索引</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#复合索引中列的顺序"><span class="nav-number">8.</span> <span class="nav-text">复合索引中列的顺序</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#BRIN-索引"><span class="nav-number">9.</span> <span class="nav-text">BRIN 索引</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xiaochen Cui</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Gemini</a> v6.0.5</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.5"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.5"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.5"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.5"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.5"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.5"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.5"></script>



  

  
    <script id="dsq-count-scr" src="https://cuixiaochen.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'https://cuixiaochen.com/2018/02/01/9-Django-Tips-for-Working-with-Databases-Translate/';
        this.page.identifier = '2018/02/01/9-Django-Tips-for-Working-with-Databases-Translate/';
        this.page.title = 'Django 操作数据库时的 9 条小提示（译）';
      };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://cuixiaochen.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  





	





  












  





  

  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  
  

  

  

  

  

</body>
</html>
